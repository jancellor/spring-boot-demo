name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: voltaic-bridge-292822
  REGION: europe-west1
  SERVICE_NAME: spring-boot-demo
  REPOSITORY: default
  IMAGE_TAG: main-SNAPSHOT

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build GraalVM native image
        run: |
          ./mvnw -B -Pnative spring-boot:build-image

      - name: Tag image for Artifact Registry
        run: |
          LOCAL_IMAGE="${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          REMOTE_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          docker tag "${LOCAL_IMAGE}" "${REMOTE_IMAGE}"

      - name: Push image to Artifact Registry
        run: |
          REMOTE_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          docker push "${REMOTE_IMAGE}"

      - name: Deploy to Cloud Run
        run: |
          REMOTE_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image="${REMOTE_IMAGE}" \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"
